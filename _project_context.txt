# SNAPSHOT OF VYUD AI PROJECT
# Generated via context_gen.py


====================
FILE: ./auth.py
====================
import streamlit as st
from supabase import create_client

# --- 1. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö SUPABASE ---
try:
    SUPABASE_URL = st.secrets["SUPABASE_URL"]
    SUPABASE_KEY = st.secrets["SUPABASE_KEY"]
    supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
except Exception as e:
    # –ï—Å–ª–∏ –∫–ª—é—á–µ–π –Ω–µ—Ç, —Ä–∞–±–æ—Ç–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ (–±–µ–∑ –±–∞–∑—ã)
    print(f"‚ö†Ô∏è Supabase error: {e}")
    supabase = None

# --- 2. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
def check_password(email, password):
    """
    –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞. –ê–¥–º–∏–Ω–∞ –ø—É—Å–∫–∞–µ–º –ø–æ –ø–∞—Ä–æ–ª—é,
    –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ email (–¥–ª—è MVP).
    """
    # –ê–¥–º–∏–Ω (–¥–∞–Ω–Ω—ã–µ –≤ secrets –∏–ª–∏ —Ö–∞—Ä–¥–∫–æ–¥ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞)
    admin_email = st.secrets.get("ADMIN_EMAIL", "admin@vyud.online")
    admin_pass = st.secrets.get("ADMIN_PASSWORD", "admin")

    if email == admin_email and password == admin_pass:
        return True
    
    # –î–ª—è MVP –ø—É—Å–∫–∞–µ–º –≤—Å–µ—Ö, –∫—Ç–æ –≤–≤–µ–ª email
    if email:
        return True
        
    return False

# --- 3. –ë–ê–õ–ê–ù–° –ò –°–ü–ò–°–ê–ù–ò–ï ---

def get_credits(email):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å. –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Ç—å."""
    if not supabase: return 999 # –ï—Å–ª–∏ –±–∞–∑—ã –Ω–µ—Ç, –¥–∞–µ–º –±–µ–∑–ª–∏–º–∏—Ç
    
    try:
        # –ò—â–µ–º —é–∑–µ—Ä–∞
        response = supabase.table("users_credits").select("credits").eq("email", email).execute()
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞–µ–º —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –±–æ–Ω—É—Å–æ–º (3 –∫—Ä–µ–¥–∏—Ç–∞)
        if not response.data:
            init_credits = 3
            supabase.table("users_credits").insert({"email": email, "credits": init_credits}).execute()
            return init_credits
            
        return response.data[0]["credits"]
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤: {e}")
        return 0

def deduct_credit(email, amount=1):
    """
    –°–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True (—É—Å–ø–µ—Ö) –∏–ª–∏ False (–Ω–µ—Ç –¥–µ–Ω–µ–≥).
    """
    if not supabase: return True # –ï—Å–ª–∏ –±–∞–∑—ã –Ω–µ—Ç, —Ä–∞–∑—Ä–µ—à–∞–µ–º

    try:
        current = get_credits(email)
        
        if current < amount:
            return False # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
        
        # –°–ø–∏—Å—ã–≤–∞–µ–º
        new_balance = current - amount
        supabase.table("users_credits").update({"credits": new_balance}).eq("email", email).execute()
        return True
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è: {e}")
        return False
====================
FILE: ./logic.py
====================
import os
import tempfile
import io
from datetime import datetime
from typing import List

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ AI
from openai import OpenAI as OpenAIClient
from llama_parse import LlamaParse
from llama_index.core import SimpleDirectoryReader, Settings
from llama_index.llms.openai import OpenAI
from llama_index.core.program import LLMTextCompletionProgram
from pydantic import BaseModel, Field

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ
from moviepy.editor import VideoFileClip
from pydub import AudioSegment

# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ PDF
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import letter, landscape
from reportlab.lib.utils import ImageReader

# --- –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–• ---
class QuizQuestion(BaseModel):
    scenario: str = Field(..., description="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –∏–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è")
    options: List[str] = Field(..., description="–°–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞")
    correct_option_id: int = Field(..., description="–ò–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (0-3)")
    explanation: str = Field(..., description="–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ: –ø–æ—á–µ–º—É —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç –≤–µ—Ä–µ–Ω")

class Quiz(BaseModel):
    questions: List[QuizQuestion]

# --- –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò ---

def compress_audio(input_path):
    """
    –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –≤ MP3 –∏ —Å–∂–∏–º–∞–µ—Ç, –µ—Å–ª–∏ —Ñ–∞–π–ª > 25MB.
    """
    try:
        file_size = os.path.getsize(input_path) / (1024 * 1024) # –†–∞–∑–º–µ—Ä –≤ –ú–ë
        output_path = input_path + "_compressed.mp3"
        
        # –ï—Å–ª–∏ —ç—Ç–æ –≤–∏–¥–µ–æ, –¥–æ—Å—Ç–∞–µ–º –∑–≤—É–∫
        if input_path.lower().endswith(('.mp4', '.mov', '.avi', '.mkv')):
            video = VideoFileClip(input_path)
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—É–¥–∏–æ, –≥–ª—É—à–∏–º –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤ (logger=None)
            video.audio.write_audiofile(output_path, bitrate="32k", logger=None)
            video.close()
            return output_path
            
        # –ï—Å–ª–∏ —ç—Ç–æ –∞—É–¥–∏–æ, –Ω–æ —Ç—è–∂–µ–ª–æ–µ (>24MB)
        elif file_size > 24:
            audio = AudioSegment.from_file(input_path)
            audio.export(output_path, format="mp3", bitrate="32k")
            return output_path
            
        else:
            return input_path # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            
    except Exception as e:
        print(f"Warning: Audio compression failed: {e}")
        return input_path

def process_file_to_text(uploaded_file, openai_key, llama_key):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ñ–∞–π–ª–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç"""
    
    text = ""
    file_ext = os.path.splitext(uploaded_file.name)[1].lower()
    
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    with tempfile.NamedTemporaryFile(delete=False, suffix=file_ext) as tmp:
        tmp.write(uploaded_file.getvalue())
        tmp_path = tmp.name

    try:
        # 1. –í–ò–î–ï–û –ò –ê–£–î–ò–û (Whisper)
        if file_ext in [".mp4", ".mov", ".avi", ".mp3", ".mpeg", ".m4a", ".wav"]:
            
            # –°–∂–∏–º–∞–µ–º/–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            processed_path = compress_audio(tmp_path)
            
            client = OpenAIClient(api_key=openai_key)
            with open(processed_path, "rb") as audio_file:
                transcription = client.audio.transcriptions.create(
                    model="whisper-1",
                    file=audio_file,
                    response_format="json"
                )
            
            # –£–¥–∞–ª—è–µ–º —Å–∂–∞—Ç—É—é –∫–æ–ø–∏—é
            if processed_path != tmp_path and os.path.exists(processed_path):
                os.remove(processed_path)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
            if hasattr(transcription, 'text'):
                text = transcription.text
            elif isinstance(transcription, dict):
                text = transcription.get('text', '')
            else:
                text = str(transcription)

        # 2. –î–û–ö–£–ú–ï–ù–¢–´ (LlamaParse)
        else:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LlamaParse
            parser = LlamaParse(result_type="markdown", api_key=llama_key)
            
            file_extractor = {".pdf": parser, ".pptx": parser, ".docx": parser, ".xlsx": parser, ".txt": parser}
            # SimpleDirectoryReader —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª—ã –ø–æ –æ–¥–Ω–æ–º—É
            docs = SimpleDirectoryReader(input_files=[tmp_path], file_extractor=file_extractor).load_data()
            
            if docs:
                text = "\n\n".join([doc.text for doc in docs])
            else:
                raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç")
                
    finally:
        # –í—Å–µ–≥–¥–∞ —É–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if os.path.exists(tmp_path):
            os.remove(tmp_path)
            
    return text

def generate_quiz_ai(text, count, difficulty, lang):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JSON —Å —Ç–µ—Å—Ç–æ–º —á–µ—Ä–µ–∑ GPT-4o"""
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º LLM –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è LlamaIndex
    Settings.llm = OpenAI(model="gpt-4o", temperature=0.2)
    
    system_prompt = (
        f"Role: You are a Senior Instructional Designer for a Fortune 500 company. "
        f"Task: Create a high-quality assessment quiz based on the provided text. "
        f"Target Audience: Corporate employees. "
        f"Language: All questions, options, and explanations must be in '{lang}'.\n\n"
        
        f"Configuration:\n"
        f"- Number of questions: {count}\n"
        f"- Difficulty Level: {difficulty}\n\n"
        
        f"Difficulty Guidelines:\n"
        f"- If 'Easy': Focus on recalling facts, definitions, and key terms from the text.\n"
        f"- If 'Medium': Focus on understanding and applying concepts. Use simple 'What would you do?' scenarios.\n"
        f"- If 'Hard': Focus on analysis and evaluation. Use COMPLEX SCENARIOS/CASE STUDIES where the user must diagnose a problem or choose the BEST solution among several good ones.\n\n"
        
        f"Rules for Quality:\n"
        f"1. NO 'all of the above' or 'none of the above' options.\n"
        f"2. Distractors (wrong answers) must be PLAUSIBLE common misconceptions, not obvious jokes.\n"
        f"3. The 'scenario' field should be the question text. For Hard/Medium, make it a mini-story.\n"
        f"4. The 'explanation' must explain WHY the correct answer is right AND why the distraction was wrong. It should be educational.\n"
        f"5. Strictly follow the JSON schema provided."
    )
    
    safe_text = text[:50000]
    
    program = LLMTextCompletionProgram.from_defaults(
        output_cls=Quiz,
        prompt_template_str=system_prompt + "\n\nContent to analyze:\n{text}",
        llm=Settings.llm
    )
    
    return program(text=safe_text)

def create_certificate(student_name, course_name, logo_file=None):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"""
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=landscape(letter))
    width, height = landscape(letter)
    
    c.setStrokeColorRGB(0.2, 0.2, 0.2)
    c.setLineWidth(5)
    c.rect(30, 30, width-60, height-60)
    
    if logo_file:
        try:
            logo_file.seek(0)
            logo = ImageReader(logo_file)
            c.drawImage(logo, width/2 - 50, height - 140, width=100, preserveAspectRatio=True, mask='auto')
        except:
            pass

    c.setFont("Helvetica-Bold", 40)
    c.drawCentredString(width/2, height/2 + 40, "CERTIFICATE")
    c.setFont("Helvetica", 20)
    c.drawCentredString(width/2, height/2, "OF COMPLETION")
    c.setFont("Helvetica", 16)
    c.drawCentredString(width/2, height/2 - 30, "This is to certify that")
    c.setFont("Helvetica-Bold", 30)
    c.drawCentredString(width/2, height/2 - 70, student_name)
    c.setFont("Helvetica", 16)
    c.drawCentredString(width/2, height/2 - 100, "has successfully completed the course")
    c.setFont("Helvetica-Bold", 20)
    c.drawCentredString(width/2, height/2 - 130, course_name)
    
    date_str = datetime.now().strftime("%Y-%m-%d")
    c.setFont("Helvetica", 12)
    c.drawString(50, 50, f"Date: {date_str}")
    c.drawRightString(width-50, 50, "Authorized by Vyud AI")
    
    c.save()
    buffer.seek(0)
    return buffer

def create_html_quiz(quiz, course_title):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π HTML —Ñ–∞–π–ª —Å —Ç–µ—Å—Ç–æ–º"""
    correct_indices = []
    for q in quiz.questions:
        safe_id = q.correct_option_id
        if not q.options:
            correct_indices.append(0)
            continue
        if safe_id >= len(q.options) or safe_id < 0: safe_id = 0
        correct_indices.append(safe_id)

    html = f"""
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>–¢–µ—Å—Ç: {course_title}</title>
        <style>
            body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f4f4f9; color: #333; }}
            .container {{ background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }}
            h1 {{ text-align: center; color: #2c3e50; margin-bottom: 30px; }}
            .question {{ margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }}
            .question h3 {{ margin-bottom: 15px; font-weight: 600; }}
            .options label {{ display: block; margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; }}
            .options label:hover {{ background: #f8f9fa; border-color: #adb5bd; }}
            .options input {{ margin-right: 10px; }}
            .btn {{ display: block; width: 100%; padding: 15px; background: #4F46E5; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 30px; transition: background 0.3s; }}
            .btn:hover {{ background: #4338ca; }}
            .feedback {{ margin-top: 15px; padding: 15px; border-radius: 8px; display: none; line-height: 1.5; }}
            .correct {{ background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }}
            .wrong {{ background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üéì {course_title}</h1>
            <form id="quizForm">
    """
    
    for i, q in enumerate(quiz.questions):
        html += f"""
        <div class="question" id="q{i}">
            <h3>{i+1}. {q.scenario}</h3>
            <div class="options">
        """
        for j, opt in enumerate(q.options):
            html += f"""<label><input type="radio" name="q{i}" value="{j}"> {opt}</label>"""
        
        html += f"""
            </div>
            <div id="feedback-{i}" class="feedback">
                <strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> {q.options[correct_indices[i]]}<br><br>
                <em>{q.explanation}</em>
            </div>
        </div>
        """

    html += f"""
            <button type="button" class="btn" onclick="checkAnswers()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        </form>
    </div>
    <script>
        const correctAnswers = {correct_indices};
        function checkAnswers() {{
            let score = 0;
            correctAnswers.forEach((correct, index) => {{
                const feedback = document.getElementById('feedback-' + index);
                const options = document.getElementsByName('q' + index);
                let selected = -1;
                
                options.forEach(opt => {{
                    if (opt.checked) selected = parseInt(opt.value);
                    opt.disabled = true;
                }});
                
                feedback.style.display = 'block';
                
                if (selected === correct) {{
                    score++;
                    feedback.className = 'feedback correct';
                    feedback.innerHTML = '‚úÖ <strong>–í–µ—Ä–Ω–æ!</strong><br>' + feedback.innerHTML;
                }} else {{
                    feedback.className = 'feedback wrong';
                    feedback.innerHTML = '‚ùå <strong>–û—à–∏–±–∫–∞.</strong><br>' + feedback.innerHTML;
                }}
            }});
            
            window.scrollTo(0, 0);
            alert(`–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${{score}} –∏–∑ ${{correctAnswers.length}}`);
        }}
    </script>
    </body>
    </html>
    """
    return html.encode('utf-8')

def generate_marketing_post(topic, platform, tone, extra_context=""):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø–æ—Å—Ç"""
    Settings.llm = OpenAI(model="gpt-4o", temperature=0.7)
    
    product_info = (
        "Product: Vyud AI.\n"
        "What it does: Instantly converts PDF documents, Video (mp4/mov), and Audio into interactive quizzes with certificates.\n"
        "Target Audience: HR Directors, L&D Managers, Business Trainers, Online Schools.\n"
        "Key Benefits: Saves hours of manual work, creates situational scenarios (Bloom's taxonomy), generates HTML & PDF certificates.\n"
    )
    
    system_prompt = (
        f"You are a Senior SMM Manager for an EdTech SaaS. \n"
        f"{product_info}\n\n"
        f"Task: Write a social media post.\n"
        f"Platform: {platform}.\n"
        f"Tone: {tone}.\n"
        f"Topic: {topic}\n"
        f"Context: {extra_context}\n\n"
        f"Rules:\n"
        f"1. Catchy headline.\n"
        f"2. Focus on value and pain points.\n"
        f"3. Call to action: https://vyud.tech.\n"
        f"4. Language: RUSSIAN.\n"
    )
    
    return Settings.llm.complete(system_prompt).text
====================
FILE: ./bot.py
====================
import asyncio
import logging
import os
import toml
from pathlib import Path
from aiogram import Bot, Dispatcher, Router, F
from aiogram.filters import Command
from aiogram.types import Message

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à—É –ª–æ–≥–∏–∫—É
import logic 
import auth

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
secrets_path = Path(__file__).parent / ".streamlit" / "secrets.toml"
if secrets_path.exists():
    secrets = toml.load(secrets_path)
    TOKEN = secrets.get("TELEGRAM_BOT_TOKEN")
    OPENAI_KEY = secrets.get("OPENAI_API_KEY", "")
    LLAMA_KEY = secrets.get("LLAMA_CLOUD_API_KEY", "")
else: 
    TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
    OPENAI_KEY = os.getenv("OPENAI_API_KEY")
    LLAMA_KEY = os.getenv("LLAMA_CLOUD_API_KEY")

router = Router()
bot = Bot(token=TOKEN)

# --- –ê–î–ê–ü–¢–ï–† –§–ê–ô–õ–û–í ---
class LocalFileWrapper:
    def __init__(self, path):
        self.name = path
        with open(path, "rb") as f:
            self._data = f.read()

    def getvalue(self):
        return self._data

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---

@router.message(Command("start"))
async def start(m: Message): 
    await m.answer("üëã –ü—Ä–∏–≤–µ—Ç! –Ø VYUD AI. –ü—Ä–∏—à–ª–∏ –º–Ω–µ —Ñ–∞–π–ª (PDF/DOCX), –≥–æ–ª–æ—Å–æ–≤–æ–µ, –≤–∏–¥–µ–æ-–∫—Ä—É–∂–æ—á–µ–∫ –∏–ª–∏ –∞—É–¥–∏–æ.")

@router.message(F.video_note | F.voice | F.audio | F.video | F.document)
async def handle_files(m: Message):
    user_email = f"{m.from_user.username or m.from_user.id}@telegram.vyud"
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    if auth.get_credits(user_email) <= 0: 
        await m.answer("üö´ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∞–¥–º–∏–Ω–∞ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å.")
        return
        
    msg = await m.answer("üì• –°–∫–∞—á–∏–≤–∞—é —Ñ–∞–π–ª...")
    
    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ID
    if m.video_note: fid = m.video_note.file_id
    elif m.voice: fid = m.voice.file_id
    elif m.audio: fid = m.audio.file_id
    elif m.video: fid = m.video.file_id
    elif m.document: fid = m.document.file_id
    else: return

    path = f"temp_bot_{m.from_user.id}_{fid}" 
    
    try:
        f_info = await bot.get_file(fid)
        ext = f_info.file_path.split('.')[-1]
        path = f"{path}.{ext}"
        
        await bot.download_file(f_info.file_path, path)
        
        # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ (–ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã!)
        await bot.edit_message_text(
            text="üëÇ –ò–∑—É—á–∞—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (Whisper/Llama)...", 
            chat_id=m.chat.id, 
            message_id=msg.message_id
        )
        
        wrapped_file = LocalFileWrapper(path)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏–∫—É –≤ –ø–æ—Ç–æ–∫–µ
        text = await asyncio.to_thread(logic.process_file_to_text, wrapped_file, OPENAI_KEY, LLAMA_KEY)
        
        if not text:
            await bot.edit_message_text(
                text="‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç.", 
                chat_id=m.chat.id, 
                message_id=msg.message_id
            )
            return

        # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–≤–∏–∑–∞
        await bot.edit_message_text(
            text="üß† –ü—Ä–∏–¥—É–º—ã–≤–∞—é –≤–æ–ø—Ä–æ—Å—ã (GPT-4o)...", 
            chat_id=m.chat.id, 
            message_id=msg.message_id
        )
        
        quiz = await asyncio.to_thread(
            logic.generate_quiz_ai, 
            text=text, 
            count=5, 
            difficulty="Medium", 
            lang="Russian"
        )
        
        # 4. –§–∏–Ω–∞–ª
        auth.deduct_credit(user_email, 1)
        await bot.delete_message(chat_id=m.chat.id, message_id=msg.message_id)
        await m.answer("‚úÖ –ì–æ—Ç–æ–≤–æ! –í–æ—Ç –≤–∞—à —Ç–µ—Å—Ç:")

        for q in quiz.questions:
            try:
                await bot.send_poll(
                    chat_id=m.chat.id,
                    question=q.scenario[:299], 
                    options=[o[:99] for o in q.options], 
                    type='quiz', 
                    correct_option_id=q.correct_option_id,
                    explanation=q.explanation[:199]
                )
                await asyncio.sleep(1)
            except Exception as e:
                logging.error(f"Poll error: {e}")
                
    except Exception as e:
        await m.answer(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        logging.error(e)
    finally:
        if os.path.exists(path): 
            os.remove(path)

async def main():
    logging.basicConfig(level=logging.INFO)
    dp = Dispatcher()
    dp.include_router(router)
    await bot.delete_webhook(drop_pending_updates=True)
    print("ü§ñ –ë–æ—Ç VYUD AI (Aiogram) –∑–∞–ø—É—â–µ–Ω!")
    await dp.start_polling(bot)

if __name__ == "__main__": 
    asyncio.run(main())
====================
FILE: ./style.css
====================
/* --- –û–°–ù–û–í–ù–û–ô –§–û–ù –ò –®–†–ò–§–¢–´ --- */
.stApp {
    /* –ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É - —É–¥–∞–ª–∏ —ç—Ç—É —Å—Ç—Ä–æ–∫—É, –Ω–æ —Ç–µ–º–Ω–∞—è –≤—ã–≥–ª—è–¥–∏—Ç "–¥–æ—Ä–æ–∂–µ" –¥–ª—è AI */
    background-color: #0E1117;
}

h1, h2, h3 {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 700;
}

/* --- –ö–ù–û–ü–ö–ò (Primary) --- */
/* –î–µ–ª–∞–µ–º –≥–ª–∞–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (type="primary") –∫—Ä–∞—Å–∏–≤—ã–º–∏ –∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º–∏ */
div.stButton > button[kind="primary"] {
    background: linear-gradient(90deg, #4F46E5 0%, #7C3AED 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

div.stButton > button[kind="primary"]:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
}

/* --- –ö–ù–û–ü–ö–ò (Secondary) --- */
div.stButton > button[kind="secondary"] {
    border: 1px solid #4F46E5;
    color: #E0E7FF;
    border-radius: 8px;
}

/* --- –ò–ù–ü–£–¢–´ –ò –ü–û–õ–Ø –í–í–û–î–ê --- */
/* –î–µ–ª–∞–µ–º –∏—Ö —á—É—Ç—å –±–æ–ª–µ–µ –æ–∫—Ä—É–≥–ª—ã–º–∏ */
.stTextInput > div > div > input {
    border-radius: 8px;
}

/* --- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ --- */
/* –í—ã–¥–µ–ª—è–µ–º –±–ª–æ–∫ –∞–¥–º–∏–Ω–∫–∏ –∫—Ä–∞—Å–Ω–æ–π —Ä–∞–º–∫–æ–π, –µ—Å–ª–∏ –æ–Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ */
div[data-testid="stExpander"] {
    border: 1px solid #333;
    border-radius: 10px;
    background-color: #1A1C24;
}

/* --- –£–ë–ò–†–ê–ï–ú –õ–ò–®–ù–ï–ï –û–¢ STREAMLIT --- */
/* –°–∫—Ä—ã–≤–∞–µ–º –≥–∞–º–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É –∏ —Ñ—É—Ç–µ—Ä "Made with Streamlit" */
#MainMenu {visibility: hidden;}
footer {visibility: hidden;}
header {visibility: hidden;}

/* --- –ö–ê–†–¢–û–ß–ö–ò --- */
div[data-testid="stMetricValue"] {
    font-size: 2rem !important;
    color: #7C3AED !important;
}
====================
FILE: ./app.py
====================
import streamlit as st
import time
import os

# –ù–∞—à–∏ –º–æ–¥—É–ª–∏
import auth
import logic

# --- –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–†–ê–ù–ò–¶–´ ---
st.set_page_config(
    page_title="Vyud AI Platform",
    page_icon="‚ö°",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
st.markdown("""
<style>
    .stButton>button { width: 100%; border-radius: 8px; font-weight: bold; }
    .css-1d391kg { padding-top: 1rem; }
</style>
""", unsafe_allow_html=True)

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ï–°–°–ò–ò ---
if "user" not in st.session_state:
    st.session_state.user = None
if "generated_quiz" not in st.session_state:
    st.session_state.generated_quiz = None
if "quiz_text_source" not in st.session_state:
    st.session_state.quiz_text_source = None

# –î–æ—Å—Ç–∞–µ–º –∫–ª—é—á–∏ API
try:
    OPENAI_KEY = st.secrets["OPENAI_API_KEY"]
    LLAMA_KEY = st.secrets["LLAMA_CLOUD_API_KEY"]
except:
    st.error("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã API –∫–ª—é—á–∏ –≤ secrets.toml!")
    st.stop()

# --- 1. –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø) ---
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/4712/4712035.png", width=60)
    st.title("Vyud AI")
    st.caption("AI-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è L&D –∏ HR")
    
    st.divider()

    if not st.session_state.user:
        st.subheader("–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É")
        email = st.text_input("Email")
        password = st.text_input("–ü–∞—Ä–æ–ª—å", type="password")
        
        if st.button("–í–æ–π—Ç–∏", type="primary"):
            if auth.check_password(email, password):
                st.session_state.user = email
                st.rerun()
            else:
                st.error("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
    else:
        st.success(f"üë§ {st.session_state.user}")
        
        # –ë–∞–ª–∞–Ω—Å
        credits = auth.get_credits(st.session_state.user)
        st.metric("–ë–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤", credits)
        
        if st.button("–í—ã–π—Ç–∏"):
            st.session_state.user = None
            st.session_state.generated_quiz = None
            st.rerun()
            
    st.divider()
    st.info("‚ÑπÔ∏è MVP v1.0: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PDF, DOCX, MP4, MP3.")

# --- 2. –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° ---

if not st.session_state.user:
    st.warning("üîí –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.")
    st.stop()

# –í–∫–ª–∞–¥–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
tab1, tab2 = st.tabs(["üéì –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –û–±—É—á–µ–Ω–∏—è", "üì¢ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –ü–æ–º–æ—â–Ω–∏–∫"])

# === –í–ö–õ–ê–î–ö–ê 1: –ì–ï–ù–ï–†–ê–¢–û–† –¢–ï–°–¢–û–í ===
with tab1:
    st.header("–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫—É—Ä—Å–∞")
    
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.subheader("1. –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞")
        uploaded_file = st.file_uploader("–§–∞–π–ª (PDF, Video, Audio)", type=['pdf', 'docx', 'txt', 'mp4', 'mp3', 'm4a'])
        
        st.subheader("2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI")
        q_count = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤", 3, 10, 5)
        difficulty = st.select_slider("–°–ª–æ–∂–Ω–æ—Å—Ç—å", options=["Easy", "Medium", "Hard"], value="Medium")
        lang = st.selectbox("–Ø–∑—ã–∫ –∫—É—Ä—Å–∞", ["Russian", "English", "Kazakh"])
        
        generate_btn = st.button("‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å (1 –∫—Ä–µ–¥–∏—Ç)", type="primary")

    with col2:
        # –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        if generate_btn and uploaded_file:
            if auth.deduct_credit(st.session_state.user, 1):
                status = st.status("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º AI –¥–≤–∏–≥–∞—Ç–µ–ª–∏...", expanded=True)
                try:
                    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
                    status.write("üìÇ –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ä–µ—á—å...")
                    text_content = logic.process_file_to_text(uploaded_file, OPENAI_KEY, LLAMA_KEY)
                    st.session_state.quiz_text_source = text_content[:1000] + "..."
                    
                    # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞
                    status.write("üß† –ü—Ä–æ–µ–∫—Ç–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±—É—á–µ–Ω–∏—è...")
                    quiz_data = logic.generate_quiz_ai(text_content, q_count, difficulty, lang)
                    st.session_state.generated_quiz = quiz_data
                    
                    status.update(label="‚úÖ –ì–æ—Ç–æ–≤–æ! –ö—É—Ä—Å —Å–æ–∑–¥–∞–Ω.", state="complete", expanded=False)
                    
                except Exception as e:
                    status.update(label="‚ùå –û—à–∏–±–∫–∞!", state="error")
                    st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
            else:
                st.error("üí≥ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å.")

        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if st.session_state.generated_quiz:
            quiz = st.session_state.generated_quiz
            st.success("–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!")
            
            with st.expander("üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–æ–ø—Ä–æ—Å–æ–≤"):
                for idx, q in enumerate(quiz.questions):
                    st.markdown(f"**{idx+1}. {q.scenario}**")
                    for opt in q.options:
                        st.text(f"- {opt}")
                    st.caption(f"üí° *{q.explanation}*")
            
            st.divider()
            st.subheader("3. –≠–∫—Å–ø–æ—Ä—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤")
            
            c1, c2 = st.columns(2)
            
            with c1:
                # –°–∫–∞—á–∞—Ç—å HTML
                course_name = f"Course_{int(time.time())}"
                html_data = logic.create_html_quiz(quiz, course_name)
                st.download_button(
                    label="üì• –°–∫–∞—á–∞—Ç—å HTML-—Ç–µ—Å—Ç",
                    data=html_data,
                    file_name=f"{course_name}.html",
                    mime="text/html"
                )
            
            with c2:
                # –°–∫–∞—á–∞—Ç—å PDF –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                student_name = st.text_input("–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞ –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞", "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤")
                if st.button("üìÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"):
                    pdf_buffer = logic.create_certificate(student_name, "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ")
                    st.download_button(
                        label="‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PDF",
                        data=pdf_buffer,
                        file_name="Certificate.pdf",
                        mime="application/pdf"
                    )

# === –í–ö–õ–ê–î–ö–ê 2: –ú–ê–†–ö–ï–¢–ò–ù–ì ===
with tab2:
    st.header("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ—Å—Ç–æ–≤ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π")
    st.caption("–ü–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã")
    
    m_topic = st.text_input("–û —á–µ–º –ø–∏—à–µ–º?", "–ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫—É—Ä—Å–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏")
    c1, c2 = st.columns(2)
    m_platform = c1.selectbox("–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞", ["LinkedIn", "Instagram", "Telegram", "Email Newsletter"])
    m_tone = c2.selectbox("–¢–æ–Ω", ["Professional", "Friendly", "Urgent", "Educational"])
    
    if st.button("‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç (1 –∫—Ä–µ–¥–∏—Ç)"):
        if auth.deduct_credit(st.session_state.user, 1):
            with st.spinner("–ö–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –ø–∏—à–µ—Ç —Ç–µ–∫—Å—Ç..."):
                post_text = logic.generate_marketing_post(m_topic, m_platform, m_tone)
                st.text_area("–†–µ–∑—É–ª—å—Ç–∞—Ç:", post_text, height=300)
        else:
            st.error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤.")